<!DOCTYPE html>
<html lang="en" class="dark">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=0, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
	<title>First Earth</title>

	<!-- ****** faviconit.com favicons ****** -->
	<link rel="shortcut icon" href="favicons/favicon.ico">
	<link rel="icon" sizes="16x16 32x32 64x64" href="favicons/favicon.ico">
	<link rel="icon" type="image/png" sizes="196x196" href="favicons/favicon-192.png">
	<link rel="icon" type="image/png" sizes="160x160" href="favicons/favicon-160.png">
	<link rel="icon" type="image/png" sizes="96x96" href="favicons/favicon-96.png">
	<link rel="icon" type="image/png" sizes="64x64" href="favicons/favicon-64.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16.png">
	<link rel="apple-touch-icon" href="favicons/favicon-57.png">
	<link rel="apple-touch-icon" sizes="114x114" href="favicons/favicon-114.png">
	<link rel="apple-touch-icon" sizes="72x72" href="favicons/favicon-72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="favicons/favicon-144.png">
	<link rel="apple-touch-icon" sizes="60x60" href="favicons/favicon-60.png">
	<link rel="apple-touch-icon" sizes="120x120" href="favicons/favicon-120.png">
	<link rel="apple-touch-icon" sizes="76x76" href="favicons/favicon-76.png">
	<link rel="apple-touch-icon" sizes="152x152" href="favicons/favicon-152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="favicons/favicon-180.png">
	<meta name="msapplication-TileColor" content="#FFFFFF">
	<meta name="msapplication-TileImage" content="favicons/favicon-144.png">
	<meta name="msapplication-config" content="favicons/browserconfig.xml">
	<!-- ****** faviconit.com favicons ****** -->

	<!-- Script to auth with Proxima prior to loading full application! -->
	<!-- The sha256- of this tag contents gets generated by Expressa.  -->
	<script>
		window.FeIsProd = window.location.href.startsWith('https://earth.suncapped.com')

		const { hostname } = new URL(window.location.href) // eg 'localhost' or '192.168.0.120'
		window.FeBaseDomain = window.FeIsProd ? 'suncapped.com' : `${hostname}` 
		
		// To determine playerdev mode, we can't get Vite 'mode' here and we can't get .env.playerdev.  
		// So instead, `npm run playerdev` sets FE_ENV which sets a url param, which we parse out here.
		const urlParams = new URLSearchParams(window.location.search)
		const fe_env = urlParams.get('fe_env')
		const isPlayerdev = fe_env === 'playerdev'

		if(!window.FeIsProd && !isPlayerdev) {
			window.FeUrlSocket = `ws://${window.FeBaseDomain}:2567` /* Proxima */
			window.FeUrlFiles = `http://${window.FeBaseDomain}:3000/files` /* Expressa */
			window.FeUsePail = false
		}
		else {
			window.FeUrlSocket = `wss://proxima.suncapped.com` /* Proxima */
			window.FeUrlFiles = `https://earth.suncapped.com/files` /* Expressa */
			window.FeUsePail = true

			document.head.insertAdjacentHTML('beforeend', `<link rel="dns-prefetch" href="https://proxima.suncapped.com">`)
		}
		document.head.insertAdjacentHTML('beforeend', `<link rel="stylesheet" href="${window.FeUrlFiles}/css/paper.min.css">`)
		document.head.insertAdjacentHTML('beforeend', `<link rel="stylesheet" href="/index.css">`) // Here in order to override above

		// console.info('Domains:', window.location.href, window.FeBaseDomain, window.FeUrlSocket, window.FeUrlFiles, window.FeUsePail)

		// Cookies are required
		const cookiesEnabled = (() => {
			try {
				document.cookie = 'cookietest=1'
				const ret = document.cookie.indexOf('cookietest=') !== -1
				document.cookie = 'cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT'
				return ret
			}
			catch (e) {
				return false
			}
		})()
		if(!cookiesEnabled) {
			alert('Session cookies must be enabled!')
		}
		else {
			// console.log('Cookies enabled')

			// What we want is; send 'visitor'.  Proxima will reply with stuff that may include a refresh.
			// If you're sending 'visitor', Proxima will certainly reply with 'visitor', and we can reload.
			// And that is the only time proxima sends 'visitor'.
	
			// This needs to happen before Babs() runs (in body tag), because that starts its own websocket.

			function getCookie(name) {
				const cookies = document.cookie.split(';')
				for (let i = 0; i < cookies.length; i++) {
					const cookie = cookies[i].trim()
					const [key, ...values] = cookie.split('=')
					if (key === name) {
						return decodeURIComponent(values.join('='))
					}
				}
				return null
			}

			// Copied partly from SocketSys.ts
			const existingSession = getCookie('session')
			if(existingSession && existingSession != 'visitor'){
				// console.log('HTML setting window.FeExistingSession to ', existingSession)
				window.FeExistingSession = existingSession // SocketSys will look for this
				window.FeWs = null
			}
			else {
				const socket = new WebSocket(window.FeUrlSocket)
				// No existing session, so send visitor in order to get one!
				socket.onerror = (event) => console.error('HTML Socket error', event)
				socket.onclose = (event) => console.log('HTML Socket closed', event)
				socket.onopen = (event) => {
					// console.log('HTML sending visitor')
					socket.send(JSON.stringify({
						auth: 'visitor'
					}))
				}
				socket.onmessage = (event) => {
					const payload = JSON.parse(event.data)
					if('visitor' in payload) {
						// console.log('HTML Got visitor in html', payload)

						// Cookies.set('session', payload.visitor, { 
						// 	domain: this.babs.baseDomain,
						// 	secure: this.babs.isProd,
						// 	sameSite: 'strict',
						// })
						document.cookie = 'session='+payload.visitor+';domain=' + window.FeBaseDomain + (window.FeIsProd ? ';secure' : '') + ';samesite=Strict;';

						// window.location.reload() // Simpler than continuous flow for now // Improved to a continuous, no-reload flow :)
						window.FeExistingSession = payload.visitor // SocketSys will look for this
						window.FeWs = socket

					}
					else {
						console.warn('HTML Got unknown payload', payload)
					}
				}
			}

			
		}
	</script>

</head>

<body>
	<!-- touch-action="none" -->
	<noscript>Welcome!  To run this browser game, JavaScript must be enabled.  discord.gg/r4pdPTWbm5</noscript>

	<div id="container">
		<canvas id="canvas"></canvas>
		<div id="right_panel">
			<div id="drag"></div>
		</div>
	</div>

	<div id="HiddenRenderFrame">
	</div>

	<script type="module" src="/src/Babs.ts"></script>

</body>

</html>